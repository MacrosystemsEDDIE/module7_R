---
title: "Macrosystems EDDIE Module 7: Using Data to Improve Ecological Forecasts"
author: "Mary Lofton, Tadhg Moore, Quinn Thomas, Cayelan Carey"
date: "`r Sys.Date()`"
output:
  github_document: default
---
## Set-up (not shown)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message = FALSE, warning=FALSE}
# Load libraries ----
library(ggplot2)
library(plotly)
library(tidyverse)
library(lubridate)
library(mvtnorm)
library(ncdf4)
library(zoo)
```


## Objective 7: Assimilate data  
This objective introducees students to data assimilation by asking students to generate multiple sequential 1-day-ahead forecasts:  
A. using initial conditions based on the most recent chl-a observations but no subsequent data assimilation  
B. that assimilate chl-a data at a weekly frequency

The desired learning outcome is for students to understand that data assimilation corrects 1-day-ahead model predictions and improves forecast performance as assessed by RMSE calculated for the mean ensemble prediction and observations.   

### Set-up
```{r}
# Load in NEON sites dataframe ----
neon_sites_df <- read.csv("./neon_sites.csv") %>%
  filter(type == "Aquatic")
neon_sites_df$long <- round(neon_sites_df$long, 3)
neon_sites_df$lat <- round(neon_sites_df$lat, 3)
# Reference for downloading variables ----
neon_vars <- read.csv("./neon_variables.csv")
# Objective 1 - Site Selection ----
print(neon_sites_df$siteID)
#we have BARC, CRAM, LIRO, PRLA, PRPO, SUGG, TOOK
#need to think about which sites we want to use for Mod 7 based on how they behave in app testing
siteID <- "PRPO"
#set start date of forecast
start_date = "2020-09-25" 
#load NEON data and format for input into EnKF
lake_data <- format_enkf_inputs(siteID = siteID, neon_vars = neon_vars)
#get initial conditions for forecast
yini <- get_yini(lake_data = lake_data,
                 start_date = start_date)
#fit AR model
mod <- fit_AR_model(lake_data = lake_data,
                    start_date = start_date)
```
### Run forecast with no data assimilation  
In this case, inserting 36 as the frequency of chl-a assimilation ensures that only the first observation in the 35 day observation period will be assimilated. If there are no chl-a data available on the start date of the forecast, the get_yini function will pull in the most recent observation prior to the forecast start date as the initial condition for that variable.
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 11,
                                     lake_data = lake_data,
                                     start_date = start_date)
n_en = 100 # how many ensemble members 
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-05', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.05),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.05),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, obs_file = obs_file, start = "2020-09-25", stop = "2020-10-05", n_en = n_en) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```
### Run forecast with chl-a data assimilated every week  
Notice that the freq_chla argument in the create_data_assim_inputs file has been adjusted to 7. If chl-a data is not available on the 7th, 14th, 21st.... days, the value for that day will be NA and the forecast function will proceed without assimilating chl-a data for that day.
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 4,
                                     lake_data = lake_data,
                                     start_date = start_date)
n_en = 100 # how many ensemble members 
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-05', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.05),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.05),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, start = "2020-09-25", stop = "2020-10-05", n_en = n_en, obs_file = obs_file) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```

## Objective 8: Explore data frequency
This objective asks students to adjust the observation frequency (and therefore the assimilation frequency) of chl-a data. The learning outcome of the objective is for students to understand that more frequent data assimilation may permit for more accurate forecasts, as models closely track real-world conditions. Below are two examples: one where chla is assimilated low frequency (every 7 days) and one where chl-a is assimilated at high frequency (daily).  

### Low chl-a assimilation frequency
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 7,
                                     lake_data = lake_data,
                                     start_date = start_date)
n_en = 100 # how many ensemble members 
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-05', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.05),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.05),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, start = "2020-09-25", stop = "2020-10-05", n_en = n_en, obs_file = obs_file) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```

### High chl-a assimilation frequency
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 1,
                                     lake_data = lake_data,
                                     start_date = start_date)
n_en = 100 # how many ensemble members 
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-05', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.05),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.05),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, start = "2020-09-25", stop = "2020-10-05", n_en = n_en, obs_file = obs_file) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```

## Objective 9: Explore observation uncertainty  
This objective will ask students to adjust the observation uncertainty associated with chl-a and nitrate data. The learning outcome of the objective is for students to understand that the amount of uncertainty associated with observations determines how much the model corrects itself to align with those observations. Below are two examples: one when observation uncertainty for both variables is low, and one when it is high.  

### Low observation uncertainty
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 1,
                                     lake_data = lake_data,
                                     start_date = start_date)
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-05', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.01),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.01),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, start = "2020-09-25", stop = "2020-10-05", n_en = n_en, obs_file = obs_file) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```
### High observation uncertainty
```{r}
#format observation data file depending on selected frequency of data assimilation
obs_file <- create_data_assim_inputs(freq_chla = 1,
                                     lake_data = lake_data,
                                     start_date = start_date)
#run the forecast!
est_out = EnKF(n_en = n_en, 
           start = '2020-09-25', # start date 
           stop = '2020-10-29', # stop date
           time_step = 'days',
           obs_file = obs_file,
           n_states_est = 1, 
           n_params_est = 3,
           n_params_obs = 0,
           param_init = c(mod$intercept, mod$ar1, mod$mean), 
           obs_cv = c(0.2),#cv for chl-a 
           param_cv = c(0.1, 0.1, 0.1),#for mod params
           init_cond_cv = c(0.2),#cv for chl-a 
           state_names = c("chla"),
           yini = yini)
#plot forecast output
plot_chla(est_out = est_out, lake_data = lake_data, start = "2020-09-25", stop = "2020-10-05", n_en = n_en, obs_file = obs_file) 
pred_v_obs_chla(est_out = est_out, lake_data = lake_data)
rmse(est_out = est_out, lake_data = lake_data)
```


Footer